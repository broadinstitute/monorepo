hydra:
  run:
    dir: ${oc.env:COPAIRS_OUTPUT}/output/jump-cpcnn/shared/activity
  job:
    chdir: false  # Stay in original working directory for clarity

input:
  path: "https://cellpainting-gallery.s3.amazonaws.com/cpg0042-chandrasekaran-jump/source_all/workspace/profiles_assembled/compound_DL_CPCNN/v1.0/profiles_dropna_var_mad_int_featselect.parquet"
  use_lazy_filter: true
  filter_query: "Metadata_Source = 'source_2' AND Metadata_JCP2022 NOT IN ('JCP2022_012818', 'JCP2022_050797', 'JCP2022_064022', 'JCP2022_035095', 'JCP2022_046054', 'JCP2022_025848', 'JCP2022_037716', 'JCP2022_085227', 'JCP2022_805264', 'JCP2022_915132')"
  columns: ["Metadata_Source", "Metadata_Plate", "Metadata_JCP2022", "Metadata_PlateType", "Metadata_pert_type", "Metadata_Well", "X_1", "X_2", "X_3"]

preprocessing:
  - type: filter
    params:
      query: "Metadata_PlateType == 'TARGET2'"
   
  # Remove features with NaN values
  - type: remove_nan_features
    params: {}
  
  # Add negative control indicator column
  - type: add_column
    params:
      query: "Metadata_pert_type == 'negcon'"
      column: "Metadata_negcon"

  # Force negcons not to have activity calculated
  - type: apply_assign_reference
    params:
      condition: "Metadata_negcon"
      reference_col: "Metadata_reference_index"
      default_value: -1

average_precision:
  params:
    pos_sameby: ["Metadata_JCP2022", "Metadata_reference_index"]
    pos_diffby: []
    neg_sameby: ["Metadata_Plate"]
    neg_diffby: ["Metadata_negcon"]
    batch_size: 1000

mean_average_precision:
  params:
    sameby: ["Metadata_JCP2022"]
    null_size: 10000
    threshold: 0.1
    seed: 12527

output:
  directory: "${hydra:runtime.output_dir}"
  name: "activity"