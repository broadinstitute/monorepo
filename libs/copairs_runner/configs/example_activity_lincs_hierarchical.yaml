# LINCS Activity Analysis with Hierarchical FDR Correction
#
# This example demonstrates dose-response analysis using hierarchical FDR correction
# to reduce over-correction when testing multiple doses per compound.
#
# Key difference from example_activity_lincs_dose.yaml:
# - hierarchical_by groups by compound for two-stage FDR correction
#
# Two-stage testing approach:
# - Stage 1: A compound passes if ANY dose is active (min p-value)
# - Stage 2: For active compounds, apply BH within the compound's doses
#
# This is more powerful than flat BH for dose-response data because low doses
# are expected to be inactive - we shouldn't penalize compounds for that.

hydra:
  run:
    dir: ${oc.env:COPAIRS_OUTPUT,.}/output/lincs/shared/activity_hierarchical
  job:
    chdir: false

input:
  # Combined 4-plate file provides 4 replicates per compound×dose
  path: "${oc.env:COPAIRS_DATA,.}/input/2016_04_01_a549_48hr_batch1_4plates.csv"

preprocessing:
  steps:
    # Remove features with NaN values (can occur when combining plates)
    - type: remove_nan_features

    # Exclude DMSO controls from activity calculation
    - type: apply_assign_reference
      params:
        condition: "Metadata_broad_sample == 'DMSO'"
        reference_col: "Metadata_reference_index"
        default_value: -1

average_precision:
  params:
    # Group by compound, dose, AND reference index for positive pairs
    # This ensures we calculate AP at the compound×dose level
    pos_sameby: ["Metadata_broad_sample", "Metadata_mmoles_per_liter", "Metadata_reference_index"]
    pos_diffby: []

    neg_sameby: []
    neg_diffby: ["Metadata_broad_sample", "Metadata_mmoles_per_liter", "Metadata_reference_index"]

mean_average_precision:
  params:
    # Calculate mAP per compound×dose combination
    sameby: ["Metadata_broad_sample", "Metadata_mmoles_per_liter"]

    # Hierarchical FDR: group doses by compound for two-stage correction
    hierarchical_by: ["Metadata_broad_sample"]

    null_size: 1000000
    threshold: 0.05
    seed: 0

output:
  directory: "${hydra:runtime.output_dir}"
  name: "activity_hierarchical"
